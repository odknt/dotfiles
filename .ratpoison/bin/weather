#!/usr/bin/env bash

set -euo pipefail
IFS=$'\t\n'

JSONBIN="$(dirname "$0")/JSON.sh"

declare -A ICONS_=(
  ["thunderstorm"]="‚õà Tunderstorm"
  ["drizzle"]="Drizzle"
  ["rain"]="‚òî Rain"
  ["snow"]="‚òÉ Snow"
  ["atmosphere"]="Atmosphere"
  ["clear"]="‚òÄ Clear"
  ["clouds"]="‚òÅ Clouds"
  ["extreme"]="üåÄ Extreme"
  ["additional"]=" Additional"
  ["mist"]="üåÅ Mist"
)

if [ ! -f "$JSONBIN" ]; then
  echo "Required JSON.sh: https://github.com/dominictarr/JSON.sh"
  exit 1
fi

CITYID="${WEATHER_CITYID:-1850147}"
UNITS="${WEATHER_UNITS:-tokyo}"
APPID="${WEATHER_APPID:?must be set WEATHER_APPID}"

WEATHER_JSON=$(curl -s "http://api.openweathermap.org/data/2.5/weather?id=${CITYID}&units=${UNITS}&lang=en&APPID=${APPID}")

WEATHER=$(echo "$WEATHER_JSON" | bash "$JSONBIN" | grep '\["weather",[0-9]*,"main"\]' | awk '{print $2}' | sed -e 's/"//g' | head -n1)
ICON="$HOME/.ratpoison/icons/${WEATHER}.xbm"

if [ -f "$ICON" ]; then
  echo "^i($ICON) $WEATHER"
else
  echo "${ICONS_["${WEATHER,,}"]}"
fi

# vim: sw=2 ts=2 et ambw=double
