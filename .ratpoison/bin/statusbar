#!/bin/bash

IFS=$'\t\n'

BASEDIR="/var/run/user/$(id -u)/ratpoison"
PIDFILE="statusbar${DISPLAY%.*}.pid"
BARPOS="$(xrandr | grep -o '[0-9]*x[0-9]*+[0-9]*+[0-9]*' | head -n1 | sed -e 's/x[0-9]*+/x20+/')"
BAR_XY="${BARPOS#*+}"
BAR_W="$((${BARPOS%%x*} - 800))"
BAR_X="$((${BAR_XY%+*} + 800))"
BARPOS="${BAR_W}x${BARPOS#*x}"
BARPOS="${BARPOS%%+*}+${BAR_X}+${BARPOS##*+}"

on_exit() {
  rm -f "$BASEDIR/$PIDFILE"
}

if [ -d "$BASEDIR" ]; then
  if [ -f "$BASEDIR/$PIDFILE" ]; then
      [ -x "/proc/$(< "$BASEDIR/$PIDFILE")" ] && kill -- "-$(cat "$BASEDIR/$PIDFILE")"
      while [ -f "$BASEDIR/$PIDFILE" ]; do
        sleep 0.1
      done
  fi
else 
  mkdir "$BASEDIR"
fi

echo "$$" > "$BASEDIR/$PIDFILE"

trap on_exit 0 1 2 3 15

conky --quiet -c "$HOME/.ratpoison/scripts/conky_dzen2" | dzen2 \
  -e - -h '20' -ta r \
  -geometry "$BARPOS" \
  -fn 'Rounded M+ 1m:size=10'

exit 0
# vim: sw=2
