#!/bin/bash

set -euo pipefail
IFS=$'\t\n'

if [ -z "${1:-}" ]; then
    exit 1
fi

declare KILLFLG=

while getopts k OPT; do
    case $OPT in
        "k") KILLFLG=1 ;;
    esac
done

shift "$((OPTIND - 1))"

readonly _PPID=$(< "/proc/${$}/stat" awk '{print $4}')
readonly PID=$(pgrep -a -P "$_PPID" | grep -v "$$" | grep "$1" | awk '{print $1}')

if [ -z "${KILLFLG}" ]; then
    if [ -n "${PID:-}" ]; then
        exit 0
    fi

    exec "$@"
else
    echo "$_PPID $PID" > /tmp/pid
    for id in $PID; do
        if [ "$$" != "$id" ]; then
            kill -KILL "$id"
        fi
    done
fi
